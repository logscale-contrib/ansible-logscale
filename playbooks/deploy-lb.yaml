---
- name: Load Balancer
  hosts: lb
  become: true
  roles:
    - role: nginxinc.nginx
      nginx_service_modify: true
      nginx_service_timeout: 95
      nginx_logrotate_conf_enable: true
      nginx_logrotate_conf:
        paths: /var/log/nginx/*.log
        options:
          - daily
          - missingok
          - rotate 14
          - compress
          - delaycompress
          - notifempty
          - sharedscripts
          - postrotate
    - role: ansible-role-logscale
      nginx_config_debug_output: true
      nginx_config_http_template_enable: true
      nginx_config_http_template:
        - template_file: http/default.conf.j2
          deployment_location: /etc/nginx/conf.d/default.conf
          config:
            proxy:
              cache_path:
                - path: /var/cache/nginx/proxy/logscale
                  levels: "1:1"
                  use_temp_path: false
                  inactive: 10m
                  keys_zone:
                    name: frontend_proxy_cache
                    size: 10m
                  max_size: 2g
                  min_free: 1g
                  manager_files: 100
                  manager_sleep: 500ms
                  manager_threshold: 200ms
                  loader_files: 100
                  loader_sleep: 50ms
                  loader_threshold: 200ms
                  purger: false
                  purger_files: 10
                  purger_sleep: 50ms
                  purger_threshold: 50ms        
            upstreams:
              - name: logscale
                least_conn: true
                servers: >
                  [ {% for v in groups["logscaleAllInOne"] %}
                    {
                      'address':'{{ hostvars[v].ansible_host }}:{{ logscale_port }}'
                    }
                    {% if not loop.last %},{% endif %}
                    {% endfor %}
                  ]
            servers:
              - core:
                  listen:
                    - port: 80
                  server_name: localhost
                log:
                  access:
                    - path: /var/log/nginx/access.log
                      format: main
                locations:
                  - location: /
                    proxy:
                      pass: http://logscale/
                      set_header:
                        field: Host
                        value: $host
           