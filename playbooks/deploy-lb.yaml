---
- name: Load Balancer
  hosts: lb
  become: true
  roles:
    - role: nginxinc.nginx
      nginx_service_modify: true
      nginx_service_timeout: 95
      nginx_logrotate_conf_enable: true
      nginx_logrotate_conf:
        paths: /var/log/nginx/*.log
        options:
          - daily
          - missingok
          - rotate 14
          - compress
          - delaycompress
          - notifempty
          - sharedscripts
          - postrotate
    - role: nginxinc.nginx_config
      nginx_config_debug_output: true
      nginx_config_http_template_enable: true
      nginx_config_http_template:
        - template_file: http/default.conf.j2
          deployment_location: /etc/nginx/conf.d/default.conf
          config:
            proxy:
              cache_path:
                - path: /var/cache/nginx
                  levels: 1:2
                  keys_zone: cache:10m
                  inactive: 60m
                  max_size: 100m
                - path: /var/cache/nginx
                  levels: 1:2
                  keys_zone: cache:10m
                  inactive: 60m
                  max_size: 100m                
            upstreams:
              - name: logscale
                least_conn: true
                servers: >
                  [ {% for v in groups["logscaleAllInOne"] %}
                    {
                      'address':'{{ hostvars[v].ansible_host }}:{{ logscale_port }}'
                    }
                    {% if not loop.last %},{% endif %}
                    {% endfor %}
                  ]
            servers:
              - core:
                  listen:
                    - port: 80
                  server_name: localhost
                log:
                  access:
                    - path: /var/log/nginx/access.log
                      format: main
                locations:
                  - location: /
                    proxy:
                      pass: http://logscale/
                      set_header:
                        field: Host
                        value: $host
           