---
- name: Load Balancer
  hosts: lb
  become: true
  roles:
    - role: nginxinc.nginx
      nginx_service_modify: true
      nginx_service_timeout: 95
      nginx_logrotate_conf_enable: true
      nginx_logrotate_conf:
        paths: /var/log/nginx/*.log
        options:
          - daily
          - missingok
          - rotate 14
          - compress
          - delaycompress
          - notifempty
          - sharedscripts
          - postrotate
    - role: ansible-role-nginx-config
      nginx_config_debug_output: true
      nginx_config_http_template_enable: true
      nginx_config_http_template:
        - template_file: http/default.conf.j2
          deployment_location: /etc/nginx/conf.d/default.conf
          config:
            upstreams:
              - name: logscale
                least_conn: true
                servers: >
                  [ {% for v in groups["logscaleAllInOne"] %}
                    {
                      'address':'{{ hostvars[v].ansible_host }}:{{ logscale_port }}',
                      max_fails: 0,
                      fail_timeout: 10s,
                      max_conns: 256
                    }
                    {% if not loop.last %},{% endif %}
                    {% endfor %}
                  ]
            servers:
              - core:
                  listen:
                    - port: 80
                  server_name: ec2-44-200-157-191.compute-1.amazonaws.com
                log:
                  access:
                    - path: /var/log/nginx/access.log
                      format: main
                locations:
                  - location: /
                    proxy:
                      pass: http://logscale/
                      http_version: 1.1
                      set_header:
                        - field: X-Forwarded-Proto
                          value: $scheme
                        - field: X-Forwarded-For
                          value: $proxy_add_x_forwarded_for
                        - field: X-Real-IP
                          value: $remote_addr
                        - field: Host
                          value: $host
